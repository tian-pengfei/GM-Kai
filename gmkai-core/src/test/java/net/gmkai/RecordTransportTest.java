package net.gmkai;

import net.gmkai.crypto.BulkCipherAlg;
import net.gmkai.crypto.MacAlg;
import net.gmkai.crypto.TLSCrypto;
import net.gmkai.crypto.impl.bc.BcTLSCrypto;
import net.gmkai.event.*;
import net.gmkai.util.Bytes;
import net.gmkai.util.Hexs;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.is;

public class RecordTransportTest {

    private static final TLSCrypto tlsCrypto = new BcTLSCrypto();

    private static final byte[] handshakeData = Hexs.decode("0100002b0101e268eeffe79d21362ef82c7db4fc01d6d13766832be1f9210f45f56c992015ee000004e013e0110100");

    private static final byte[] handshakeRecord = Hexs.decode("160101002f0100002b0101e268eeffe79d21362ef82c7db4fc01d6d13766832be1f9210f45f56c992015ee000004e013e0110100");

    private static final byte[] sentFinishData = Hexs.decode("1400000c834a7c781f6614aaea03bf5f");

    private static final byte[] sentFinishRecord = Hexs.decode("16010100507067c6be069440d9c330b27e326d07404391947c5d279f3d13d6071bacdb888ad75ef13063eef559371686fd77f4a3853c7ebacdb7d3ab958773fd38ae4955bb5d389c4782cd1592755d2d7319a791ba");

    private static final byte[] revFinishData = Hexs.decode("1400000c678de5c0d82d236e556aa839");

    private static final byte[] revFinishRecord = Hexs.decode("1601010050536c9d87ee296416b67d80161d8337f2f15cbe42032d500d42188a8cb6dd744676ca1ce3d36d15d00303176dae340affd55dec69b09480acc12efd3b645b5015844def8cfffb949509756a8238f09bd6");

    SecurityParameters securityParameters = new SecurityParameters(
            ConnectionEnd.CLIENT,
            BulkCipherAlg.SM4_CBC,
            MacAlg.M_SM3,
            Hexs.decode("4f3d70a75587aa091688b65177a5d3c1a163aef68941cb7d07b723563490fc02415fb521df8b2265bd08583f759ac6f3"),
            Hexs.decode("01409b782f68c8650fce8684296ea64a74ebbe5c067a48ffbff8c534d3dab775"),
            Hexs.decode("63369bdb6b59d99c965b975c67786a6504b1735d85a304e4b6e35d7d5a47f684"),
            16);

//    byte[] AlertData = ;
//
//    byte[] AlertRecordData = ;


    private static final byte[] sentApplicationData = Hexs.decode("474554202f20485454502f312e310d0a557365722d4167656e743a204a6176612f312e382e305f3238320d0a486f73743a206562737365632e626f632e636e0d0a4163636570743a20746578742f68746d6c2c20696d6167652f6769662c20696d6167652f6a7065672c202a3b20713d2e322c202a2f2a3b20713d2e320d0a436f6e6e656374696f6e3a206b6565702d616c6976650d0a0d0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");

    private static final byte[] sentApplicationRecord = Hexs.decode("17010120407067c6be069440d9c330b27e326d07405a3acd8d831bf0d1020bccb19e8fcd09de8fbc95cd58cb2641a45e4d51ce9029827865781535f82ea49fa576cfb89c8bd0c8fb01e746e9df81000cd95a00c15a2a4f47547b68022d3c14b3ba65d4bcd4af45fb420b0112cba7fcf9638d438ff69157b3d714de36324de07df94d6c35f6e493feb077f0781807594228cbc2056d566f53d28148ee74ca2c34745abdf18f23e6d3a3719ffce3fdbed4a3a70e27fa60f1c037b00762dc58b38133791f266c5b97dc35371a3135e911c68f394cbc31da0e44262ef104bc0e3a8b26a1fccfa4fbca980ad2a2e367f60ef365510d4f4f898869a6d1f7155fe3f235eb47fe5e537459c11caac52f3d69c70b025f41c65a98d480c00d2c6bcfa282e1004bf0a06f6063679c819136d467e74ea55424bda6e3e62c3914c5576c90b0b87bd50e5f53be730ab04fe2ac38aabee22488ffdff9a8514873043badee05fc0e46f751165c8142eda522eaadba2285f87d818ed36cf8b668999cc35fbcd16e6cb37c1d81b2531789541527f6538adcf759e1915fd326ec44eb03f67bab8fb1c946f72985388685070e684c78a8197f16037dd8c86f53e0f7ac943c34af9c0745ea4cd5b67d2e0ac62dd7198d8f693979c85854f2b08b551d76bfb32ff50690d5fe4050fb73d5407795ed9cd8255ca1791c740bee06c7565b30bff513cef3b249c792ff5b201116c8bd5a25be3281949b1ccb38f96fdfa3f1d5f900fbd2129a7ddba77feccd2f475d36e0755da2e66463d3114e63dcc003fcc365c0b1a9032b94dd3ac4731b7a80d817be543eca6c687cb474d785594a8462985e8463075497ebfdbdd4dedb76a6a144491cc7127a8121b3b3add2a6e7e9e81b2207c847761d3c7dae341674e830d7eecc60301a563ba64054608e703fa5fe573d70230a68f14efbca75f40138daf87cbc5438f5fbe13a8eff3697feab5fdd5d9f9c88f891e49481a964daebfc1aaae818f1c4a55997ae2985fb6e3273757c0457b2e4d82298ba1809ccc763139a03063c2c9f94fc6541ddea2fc2f9eb9e0d3388d9c5d5178692c51a342910f5f6775597da4cc3cd1e1e573ef124e596e10cd7590979f6fd1989219dcc6dc9ef93299a5f203e0cc5734caffec27d53f22138b3139b3a178aebabfb286d86c495de1ddf5923c5d5b332be7b02cfcf6efa4ac6dbe1e32c2e9756ada63a519e62983550b0fc687ea40dfac8cd8b48e742005850695c207e007610bf39454c10f0f047642ff0969820101f0974a33ceca75f26a35bac51aea9ce7f36c1ff41423035cad32d6f0382fc33964ba997f87a888950bdde3ac6ed497525d8deba2fa0f1e1ceb7da960c2e7f21f2490bf95cef851d21f75708f3f45fe2e42165209d534e7b9b6b1fc5644c774509e944ad61bbe886a48c4337ade6cf8f481e417bbaea1e3f1033b10bbf0a528c6cc054d99477e2de1a477218507576e48a4573da791fc1c9af7b724338a41159d56ddf7dc65cafed12a2f8b40ba42db48363b8c50c4c2ba259067859d9495acadeee0d03aa6b0f7733eeb0ad4b09b73060163de947181a58501ebe100c6ac24b621d859660cbc48b7de238ed2644d5bad2664c0f6e4e18a2cb7a45ac6aaa9948d2d9118e112019dff2b7c1b095f0ecbf89b03014ced671e65c9b6a549600ddf39af5e5ddc62d06dfd6c7d23c439e47d20cb6cf1924b94b6aa7d1adb4d6b896aa6c239e29b6f937f4c937865535e5e2a0071925dd0ccb45573df4c1aa6ecc5dfd068eedff0e0d5b2b2a068e224744fb7f62bd51c440c269aad0b2b1493e4c4e901340c82318f16d30e9f7cd3c7b92f04b91b5ef2a1f8a564e6ad9bd64e831b183c8107d86a2434f2f011c64ebd28c1e7115a2ec5ba9edc79e726cea031194cc377866162e913549eb18e0245caffe37044dac2eca2614e57652e63f30c146a0bc7b3f3841c60a8f47a66b2b5e769edcdfd3a1d9480f924e3d2d7609d07d46ef5bed637325f0686ef1bc6c2261ab2ed4ee24fe7d82f9c137f0972856d05b4b7cb69427248cf967bc43411148d14c17d83b534c9ae0bce7b702a165615c3dbfec2da24e71b7710b87652346acd893050d5cdffb5c42480917992f80f92027e19672489010ab61be231c23ca912e09cd26565f01aa1985692b3a5faf9074ecbfb97968071a5b0ab27eadcd07ff9b15fedec8d8e70215748af00454ef4a95eb22b99928636908d484649ed86a358e6dcf0db26fc3426a952ac520347710b4ed7bdaf0559069136a4c8979f162ecae8bb61603751c3ff510f26bf4c64aa0a27ca13e6290aeaac2fa3901f2be93872d530d7b4350915f3a4e5d0ff70bc1c3b74ceeebe9b1b7e233d2dd0ead563ee8570cdd4fe7093fc1da66789e6ac4ec603da59d824482b003a36f1f4099666721e274be9b16264c6263162d4e7eafc88875808a0e3430f5a0892dd42773cebe5c7f92317972b23c57343be0a1c0b1c71ba9714e0c9f82cf0ee6b6cdc4d39990eb3017bb670d011be2bacc3d0dbe30aec1abfb1e28f1cfec2c5f198de5d8ae68202cfd7065eaa0b456280eb1a74fbf37fd4aed12334e701f2d0b5c50337ca2631c6cc10ed9543c41a0982cb8b0b5c6a5e2312205ad8a22c56712e659c10c674298927fcba5ee08c04ae27e82b9ca79d1b71f1f9940dc42ea5fe192b6c8552a6d6c3465108264b28d1c01915e64d1c421ab4bba0127a1497085e5b0d5118caad7fe873f187e7768b9a03d0353c2e797f8d0f31495b7b7cc8bb8853b4aa05840b90dd33c826aa7e8a4b55bb926942121d6497bc299eea4d1a98eb1cdef9a1b6cc8bf25dc5ffaef9c4c1e49d8be22f89065aedea8ab2861195e12702cf96a0a0eda19b6e2ff74b88a3d7c63279696a01424eeacf1fd2b2bc34f8f313468841ae268b005a2fbc959a27190acb2921e67d21b2b475d86cbba64ec6aab1affcfb6d6a22aaff86752a017e619025a18e1f2be0a19d4bb036e8a6ecb491e815ed46daf6e7431378e9ed1a3ee8555612f261bffce60e5a4f861c63811bf8c5a065a3563b5dff14c9ad0866db1812e6e41d4da42cbd6f1b21ed82e0788bcf51ea7e5469b754fac8a7087e2955d1b323d046bfc29a389d56e77bf5db0ddd78121103290c04db8ee115eece89116990d1ac93ded7da7472e643cd4558cfc14498b82ba36a163679c7148e99de1f61b424946f4f4caea3c4cc5f9d68f18d307224ca74d50f6571958f473685fd7efaf4458e70ad4db3c809a1f2c7a1ac95b1d269e66edb6087b4725dc6384cb954606bde1b8b03296f52f97856140e94a824d150c44f6b1870d960047139b448bb6512b5f0d57dee21d21ff0f9566f93c5caf819d2e15e73ad20c134fc1cdcb9586dccc4078fa383186d264f8666bc53c42a01ac4337112d2e9e53be79d0ba49497a8d977bf5b39623bc1305e4cef201d383403dd0d170acd6757368385ad0762bb2f67ec256a8f809e53c3604f96c6688b2a8859aed82adfb384faecba1a9c3572e3fc243433e9cd4d59a6d528f61d1731c7d979914e86da064069138ebafe966deb1dfce8a072c59ef09277dfc6a24d67d5b0444e7dc1c21007fc2516782529837c77ab405057c1afca86aec19bab7a3479b805aea8494eff8e8cab845c7cf87d44a2c291eb3b556a51af8019f234577228e7c29347ae04d3d19316d25fffe92ed674ad82ced323239530da45aec7d6ae4889b958e047b308d616bf459ec03d7c87d02debc8f02fed9a94eaea3bcb20fa4a720ca94b3d7c597483a567997523a70c5cf71479bae98164fb349ac35fbcfa5139aaf00066030050fe7f98d887b6d382e71af4360b1b4f4514bf85257cafdae691c577a1e88d18d785b6796a4067f28d2192b4d68b1df46190f54f7ab31f47fdb293b075a466ac0d05c157f52e4ec5996e6b33b62cc1ff805ab0087a3d3ee3daff26ccd5ca64682e73f2f615802a2bfa27c4572e8b21140482a04c65ddfc8e4a928434350bb1bb70aa3a6e147d9132898c3a078f193a60ebcfe26235a8497309f6c3abb92481fd3d74efcb484bc4c1f4d265d31f17d7d84e397e1de291bc8443606526f9046e8d2393bf783223745ff9ab900a02583699d257cf6e3ebeb3cafa8b1a23ab2f27a8e041fe979cc3a4691220bdaf5323c26dfcf3f701e9bc8487ae9a02d7e5cfd5cd9847021798d005b3542028b7e3d27585316a1500d9b112fa328d0ee1f3fad6e5d7724608d33c447e5b3aef67aeaa41d0914db519f5fba78ba6fb2e27281cd705fd3c75fc62ad369fe9c397809d5f10169a821b5c93b012ebc0a6d4c08f572f281ce684dd5addd8c1feb8a2c9cd5a1bb10fe699e7ec0d9a8abbce0e3d30839fa2aa03f54faf81d1848f1895db7e94008f98f8fe07a3ee626218fbffb9773888b66f0b11099b3fc4cec061708f6d34b66568d08d1df201949d9f65d2531d54bf6282fe085c2981d3545f007e76c76d0773319ad4ad7fac7ab27015ec0f97f37f133080dcb3d430a70a2275da1adcbb269b5af84b34269db31147dc79a0e7dcea0b26bad9ee1e5028996c4066a7648bb76cf1eb8abbed08dbdfad28f6b2ffad0bede4cb4ea2455ea098ee522ae3731e3b709edbcd5d14f7f4d6edf70830a1e0e56a1b9b426e6c72028c44496f08693c727ed13c873bc20a60747e868c672de3a557cc57efa52574827ca77a0a6129dbeda8aea752e804a71ad4f721909c946afd24d64508f1251ab7ded19cf37c5b1577eebddf55bc16e034f6583de9d7ff1fcc658790b22839ea97272a1568de62c70ec5e741a3b6106cd1163dae62533314e484bca73dad4a3ac40dc7a4d8972f061795774eead568ad446bed3aa97bda332ed17007fbaa4455d61b519e5c035a3437b3870af9780c09c153457e71e6420301841e9f30d8a6f6ea37850ec6e40cf1d3f86c5d85a57a5969ed6c033c291737f241ed28d1a2503616ccd7b0e66ea5c8386c1d1d8c3a536d0b55814818fc2e3c0ef5607dba07c4bdb54b79ec9ea52e8707dccdbfd0e0f6aa4143e7ed3952f91e3d8565a0f693be627d9099ac0511e551372a708d235f358ca15671601c17a5c453a91a33b2feefe6871259e1557aac2f2eaf29315f113c926c61af51cebd326dd90183d3200c697ad4fe8ec2256feb52bade13963909522175f2c3292da4b5301a3f747ece1c287a1e82dd550abd33134c3c82a40f81fb2248b214db6727ae744c2e15aeef340617b78a2955f3b09836160ed4a873e72a4079958b3cd26e9f463f90265ad840231fd6c83936c173e6b48fb53977b5cd3e373988cf7ee43a82d7e6d24ff76a58d4415918f6a37784ebe47d17bdfa980dda76af298bd8544efd078dc00c740c438b5c3397ab4f4487aa238338a0cfea5d2d30a4586a7e3a26afcf51b5f455e83c963328be993c460aca7fb3eb40659adb3f0f05bac1762c925e60132fe17e2ae67a61b995962756e7f1c970b1c6715ea7e9c778114beacb8d59047db3799a2c700d97aa481813130b78838a1cb1bff6d9f2beafa3aa8e08a1f57b27afd56260df9e5f1ad013109fa25c53fd41977957da6eb827b1b91c574fdf6246425d43f08b490db1dc895ec90e43d0cd0c58b8f5db9266f08c70b0c715393f73727ba2fb8237035f07d5ff7eb90fee849bfbbf0e2c376c1d7e67b0b1207410276ebbc445efe7fbbdc78b1c12111604106db5618409af6244a806618d1f84be82ada8119dbd387d2e117676b45a5f13b6c8ae2d839f872e786a215843e664cf545aca931355548338d4d5977b68a33a0d349a66b6530e607306c2e2d16209c00a21645c3d20592a7930ef7bb3af42e0d4898e4448d5d37d0afdb086b480d55edc575fa207416d4efc5ad890b843d94d03a24c26f3659afb4a271985701bbe54f41b61c3585b270b71da8f110812026bad246dd136c1a6bd48705e8fef0eb8ee2e4c482cc93ca650e216f8c56b6215a6fbb6febc6ec75a0694374c5f5ecb3d0c00565fecc4b13fb8ce7c6755ad1baa07cf15ad13dfb4cfdfd3bac39dbde7c6ef8518b5a44de390ce6bcd4ed89551ac64f49a5c61749f7ccb5146d7535cd1651cc2b66fcbac9a6566bb6d807c6eecdaae5d0f802a1159289531edd65a45cf299f6e8060bada49816d7989c9b86cb3f97c03443f6111c3b8119a47b03f0c6ebbfbf23e796dc7a41ef5884fa49a94e7db80f36996abd17c945e3ef958e9f3f2506a1ed216193f889c394899aa58166bcabaafa16dff42ef7be822641d924c6b4c6a9de747485bb4e13fe955aeb9c35af1ff56737fe171582d806d2d87426a717dcec40838b2dc8ad3f5abb15a59f66093a23b2fdb744df49dfd78546c42a5f3a2b90bb08b121d29f7a8fab9b4476ee3f67324222abb5e0ae882b0c37d088662cb4a1ade65f09208d32748e595b4fd40d011d7bb5ebf6248120b6f115716daf6c7915394cbf2f495c1186217840da4f583dbb6ba055354f06bca1badd9573a264384312026f73dfb4f33d49fb55c9e771d53750730459bc64dc73d440f89e0c0d58f3d0005de97238564a6fa6e2a1bc94291700674e10ab520c82b4fba648b85b16d4eff4c825355d534deffd50ea9f3cd17ff7eb5403e5aa53c154625a8ad6cd0cdf61e51ffe949d470ed753712247af604a5dcc3032265ae4cc0bf5218b605d47fb344bc2263ab60a4e537f7fce0d5a199cf484890a6463a9c57de91dd1118dea11b46eccb6e64cde71045ad03bfbedbf9f92cda58c1c597fec3c4f04d09aff615a4de7413812f86846b3bce65343bed0d82f90bad33c00586da3f722ff5dbb2131b697ccf8c212ab130fc4b61b8637d5ed4f4952e5e07df3ae27e244f89c47b96a7d559711308e418e604a4ccccbb2cd9b256d67c256fcfdd11cd2b9bf265a6ccc6b5e19e5f663d2dd649da055a3882a458d32359d848e5b8505cba0745b24e97a653a4cc569360cbb29039ce24f2b5b8109d22e446345b7b5fdd14884fe70dc6304ca6ff25f933aebf0933d11f2eddb330ca98a441afeaedb90f2245132056175adee86c54680a6b7c72699aa196b9783d8d490abb2244b265b9c89db4f783593cd08c7c11fd73ecf4bea8a6743ffe7904a0074958d8ed8e0ed8fcaea560c86920b039a3e653082fed294666ef4b1643f2d27a479bc8296bafd45fd8d07cf96290258e5ef47f2c5185ae3e449a0fffbb501b8aecaa69d625113b41a655b2866e187e685a5eb04cc32b5ed1e44f1146dfedbb22dddb0f441e0306eee5e9dbe2a955bdf94e58aa015fd4e789c1af3d98bc25ec251e148081e8704b1e25e2a08026eb44678694a6e4aa51da4b884136e7bbc25d2985965e949039a31f8ce6dd7e44a836a4722b26b42baa7ec9b3aabe6bc0aa9054c86c37dd068becd81b186bd22f13b9d5865b884703bb712d5e6352a1e72d2c8c2f66396d61920203c384071b4a3a53f815a82b336d12eb5e3258e268a4d48819b0e39b309346655098994a96ed9df7b7fe1839b794e770c32db8803997b4238865224b09241ac17b94b3cd1f1251f347cb5879b9eb78dd01db751dd88a72c5cb55b406b35149ed47ae419d67c38cbaffe1420ac86bbacbaf007f557548bea06f405526ebf5e998432522cb98338119bc4ef1e38f00b766e6cc54604a4671660a9a8a5925339131382e7a846d6d44767d93c0a9455dd25967f50db0f17a4c43dd0b22845e4587f6259e4ec991988d887ba9185cebdbdc937305208ac5e485d4c9e460006d38cace2ff2e023349e48a28b72ddf09e1b790e28bccf8b98f38610aec1c4ebfc8bbbaa6ccfaf969b314f13a5c31015055a8be22934a4a16c98034b60b24f49626493064a9fd4ea4cd3be08bd358012010f819ecf3808754cc7e0cc08f059de9f7a75d4e749a25a298a6b06ff97e9e15ac58da6c939d26772683c2711ad76000f59706d421f4271ea2abfd1a0411a4548b5179037d705311ece9922a05965260a51dab76f19435f4c23150f6658163e236c7a2636e2339cf12af7cab024f5f98721af9060bcbff33fd3899031526e85a2846e7244de78498ce944f51f478eaf0a47528693ab109b2d77ba391c840801a9361b0454d3c27378ca7d583e294d1b43254f9e51a06af1f9210683eeba72034a20c97b6e1b4a93cb92bc481a4b5d19d48a493a871b20d6d8e6ce00b0ce8e486bb646e6d35fd4e39bf3c67523496619dbb576deace3be4960430cff95565370b20ca536df2db12c854f48a74562bd8393ad9718d8c7ca9ff18f06debb5ece460dcc17c24a22c8ccc8702184fbe9b7b04fec85ed1d133c89e67401d0a2ba737aa2b4bff66f77f40df75cffd7dd7bb8f880fce5844ddf188c39c53ece80ebb5470f08fc2ea539b6a7f5830b2c6c35186c34deff8a6adadc27290e3305356033eda35182f023ede522b5f39a6792f3c49d60d689b26b9968df79dd9a5ef0cd678c6ba6fc6d008e3e3f1af6e6ffadaabb89f1b2efcffa99b0f9767fd62414c454cc1a0e2d1230541fe05410595f5a4d2e3738230984632bd09e02152b272231655d20a5b0d0a4b2edbe0073e72aee26e678727f035706be617847885d439c74b637cd86abcba6f806d0bc8dad7f98cf34b47814b999aaaa26504b56766a8cf380a5632e7f91abc5a556be6f972d95f70b9b8cb358d0928e18a791d1f0fea92e8424a1646b059d7697c54ca066c3599bfc08603fe9b8b08b61a352a06c59a3318ec6f9c6c516197939806aeca010999cfd6ba81134a27f0fa416f5e94733a5e1369d84046c9919aff8306958152686bd3766190e17d1290817e25411622a26a7f41d12a699eb3727b8f4e8597c5cd5a3efc23832690b63b47f9049fe1cd4c585deee3e03bebc233d8755d09e911725aeceef172bead0bef5fe977edb0005d7803d2b35c0c1f7db4d5e588c5bb22845e56f06305e3493a19d3021645bf25066da3f5309c9e8ef6f01f54effd38634f536b651cb61ad48ddf8108f63f29faa635e9d2ae569e6345439ac222d74cd283d53080f6aa59b324c04701159ed2405e59fa431238cc608717cbf235210985b2ed0bec3ce1af9d13749a94da44a908e966070be24fa523cab9feb63d736926ef3ae66151b2cbe33924e348f04705f07be20375afb3ff35d04be34ef334477bc2010e694a50271431464233bbd135bee8afba9fe6663d4af5ed5d2af2c36c2cbf314e443716752f44ab1defbc17c25b9589fcaefa1b4e80036eaeffb7891f1d051eccf30999bfad6fdbf07864d685766ffdf6e90527ce2b995ea5b51f39de1272438a5d26906bcea1c3d374aa3a87548e60b02a67650c528a36da22949b10deb034c6587a31b9ea65455e165cd42e1a1ccbc5077ee834c5c7ce1fbdba220fbae2fb337a60d97a19ad7caf88f50c6fc339d970d8706f4de343a4d1d9af31d0d3782f6869ba392684130a6d9837cfce1ec246c862077a327ac343c53868904a0d4eb7f7f449e0150d02c04461de2cc2b30f003c3f26d80e43e824d3225c67aedf966fa18abfc9980fd62e660c1b665ee6cdab2d1bb4ec4dbecbb50161b46194b6f935b98092ffb4fa9a09666b971e3a4c9892f5a5d2070881804eb8cc6b32aa9790bd579e22994198964436c49f4a43f699cf4cd0ec45930a4fe781494e91baa4928e8c4dc1e72d5ce79934b484655ab41b7cbf5b2f9d6d95e7ac230a3e8768f4b6348129a4656ec2c03d9b5439272aff729498c7231253741235fff531d28fb79dcabf83ce6aff0120afc5fa80ad42b72928d960792a9d15bba1522fa1b5319efd33a8838761180bc61ca6914cc5eceac1048f20397bd569c07c6bb598b9f7d8548e5bf5bb61a6a1f15f6e72c79142cb1802a6ea8eac130fb575e82fcd55c1d72c73c396f03617a7b45f77bb9c129492922d754a5aa5d723f18748f0c037fa4bb8cf396353eefe3a9c76510a10f1dda32bc60089bf83f85a1bcfd6059403da55c8a50bab1f54363acb448bbc0f40298d812b8318c3f39de49792b3cd86e23a44d0fa98a49a57e3384dba9e18034bd1b22f5c7d645eaf020260b492c48213d76f3ee84fc869cf5f21718330a983f78d40834e2b8d3b8c803dd00badcee6510e138fbe73574f4fde186fddbd8d391715ef8ca199d4dd40658dacfdb88dd38c79c6c1f01bd1fc303484bafcdc1a105ffda20438c34ed4b9ecd3a2fe93d67019889a39ab4059932f812a29be38e3f1a527f9342fd7204f0783a0ac8a56e8472c31d0c527b80df6f2590b50fd9c4856fcfc85c5c480f7d6db8fdc3e5c5c279eb5655f19ddab9c9fad091d7578d108f9c519d74575900f8571b5153dfc65be12a323d1adc4a49114e585f3167e77f08cc5e034f3202507a835787c0aa54c51000245f771a85f2c0db84680e74ca9e8f12e8a084c2c1ca1673a531ee5f9202055e0c0e66afbc2f66cb9333cf6d0ff58624a8593574aa153bb7c466f4ee3fe321e037921206811141e8011a2edd64b08322d1db73ae4c533acc147c1c90974443d6a2c030a255e4844d4452abcdb042cfe821fe87a7b8d02aefbd6d6f21e2708846c1d1227be9099c18db71e0ad71545477f0e623b28ef506c684c1aea2139ed956ff26ebf00cf240231ac627bf464723d48bb3968f88d544082560a694896264b7275496bd1372ab2fa64945333660da5a2d5a12e96eebf2cc5dc4e5791eeddcfc580dde44aee7756201bcf73eaae2abb2e570ff77cb994d480c38448837c3dc911ee49bf6b4bea06804b0cdfcbb80b555035741c88229ebec7b66ae082006e1c33707bb9c8ee5ed7db7144ec23e48efd74f66023dc609f75c60d8b8935714a2bd09f8db6bf21370eb934bfe7bb3ef7e42a75e1ca2a6714fdbd22bca1a1915fb43f171e7e4a04b049ca41b2cb87b381cf3fe12ed374e196644610ae075acb5687f2a9a1e2802c9fe16a0c82770df20b125581ac94e7f85ef0afb9a712bc759df2a479bb83f73611c992e82f12a43dfab29b3225185421a21ddbac64b24af7738e04d8b16eeaec10d5a613b7bf2f93f607d26210d9436082103c55a25a2ce49d1981ba788ab3e6b29acfd71563b557141a204bfa40cff4deed4bd923cd27d5498fb53fc9acae6b79e090f105f0b2fdba7722eba0a700fee1d8fe86dabc831f2382bbdc22203340a02ad6b7d2232937e88c3711ce5eb58c0ce0024423aacaadc52b355add706b50e1003cb1e536ebc7c6fda0ab5a89ba8ace66610b9d4048e89982a64fa92bc4947790c41f0fe71259a64ec79d935006545cd0b69cc10ee45cfd2f53bbd4417c083cab3393f27ba82424fc02be8dffcc4b68387efd96971e031f5329b20368c6e5a6131e198eed65e6283063c897e322535ffc79018714f30ef5062cc4d36af6f7d6deafaa03c59f57e24fced06b6b27b6876813f4f388135e521bf4b72699c5c7f3d9bbd72a6158d63b2b39bf7ad72e31e60523643ce8659ece1f177844429b39e4ba589559e3214184582e2606ec6d872b7f613e915c1950f58c2c7289320da224bf6fd3f9bf292050dad2415fa44c91f2d2b401942053a93a3f0a7264a560a3b8c77b58115cbeab76020a9ca5afa4e36d4c1828ee6b0871c54ab3ec29c72398d515622bc85a1b6b08c21bcb18ace55f417f88b76b2e308afa0767ca00e8ed41ebd561357f119b198a0bde276d9e244e62d6c877daf5c569a8314");

    private static final byte[] revApplicationData = Hexs.decode("485454502f312e3120323030204f4b0d0a446174653a204672692c2033302053657020323032322030373a33333a343720474d540d0a4c6173742d4d6f6469666965643a205361742c203237204a756e20323031352031363a34383a333820474d540d0a4163636570742d52616e6765733a2062797465730d0a436f6e74656e742d4c656e6774683a203135360d0a43616368652d436f6e74726f6c3a206d61782d6167653d3330300d0a457870697265733a204672692c2033302053657020323032322030373a33383a343720474d540d0a566172793a204163636570742d456e636f64696e672c557365722d4167656e740d0a4b6565702d416c6976653a2074696d656f75743d31302c206d61783d3130300d0a436f6e6e656374696f6e3a204b6565702d416c6976650d0a436f6e74656e742d547970653a20746578742f68746d6c0d0a0d0a3c21444f43545950452068746d6c3e3c68746d6c3e3c686561643e3c6d65746120687474702d65717569763d22726566726573682220636f6e74656e743d22303b75726c3d2f626f6331352f6c6f67696e2e68746d6c223e3c6d657461206e616d653d2272656e64657265722220636f6e74656e743d2269652d7374616e64223e3c2f686561643e3c626f64793e3c2f626f64793e3c2f68746d6c3e");

    private static final byte[] revApplicationRecord = Hexs.decode("1701010220cac613ff7883fcae7ef33a7b3da26fad841f75487a4e0fe388800a5790291c4d52b105177755c59401b3d6aeebf395751a5ccf4755565808aa5bb7c2bb15670f44ff3d70cf1a277ffaea106bb9f1c2eaa454987042f22c7f46659cbe1dacbab70d303d800b23617dc09df48eae10527c86424fb848a4449e9fd32dc4e6ff92bcff0f1ce48f9b13d4c7be7e814ccf3e58e8714648be0f535d886d0b9e3d19cc83ecab17f4e1c844945ab42924f414903e5d3ea03136b83f7e4b6b783a5e825046a13d30470fd0a2cece6a7e87fd0f9fb896d76f759c56e2663a8913f6537c6cdbe0d6c19078cb05f43e2a18c40c4b349e9c1eea0da630584e27f0dc8dc6b04b5a11cdfc0f9ea481e42b9101bc68caebff65f097f5d2ca4b4b6369f2df6a426c483930524811310c567e66d6f20abc5ca871540d70a93334cc801a3fea9e9f8237315e5132a829a5a302372952d4e88cfb831c5462634c8c7bf9e80fdd813a2147753b9a747b863b1b78b48565e90d46fac771e13ba1b561b08acb7bcafb0179aaaba38c5c942be929c8eaba28f6f7dd8535f065800a79ae43322ccd6114b9adaa0916835e65ce960bbf6f55f1ec286e110399b0dec8ef1439a083762844749964b87da2fcadffe6f77fbe649efdc324dce10caf08c84cc8799c9af3de1c9079573b35bd2d45fdb416dbf8d6056d60d6313670932f79e373dc911bf96d7f5e38154c8d6b9c4cb098cb4a8415991fe1edcc8cf12f96ce7ff5a6dadea1fb217c203a");

    private TLSEventBus tlsEventBus;

    @BeforeEach
    public void setUp() {
        tlsEventBus = new GMKaiEventBus();
    }

    @Test
    public void should_read_handshake_msg() throws IOException {

        ByteArrayInputStream inputStream = new ByteArrayInputStream(handshakeRecord);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);

        HandshakeMsg handshakeMsg = recordTransport.readHandshakeMsg();

        assertThat(handshakeMsg.getMsg(), is(handshakeData));
    }

    @Test
    public void should_read_handshake_msg_after_update_cipher() throws IOException {
        ByteArrayInputStream inputStream = new ByteArrayInputStream(revFinishRecord);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);

        tlsEventBus.postEvent(new GenerateSecurityParametersFinishedEvent(securityParameters));
        tlsEventBus.postEvent(new ChangeReadCipherEvent());

        HandshakeMsg handshakeMsg = recordTransport.readHandshakeMsg();

        assertThat(handshakeMsg.getMsg(), is(revFinishData));

    }

    @Test
    public void should_write_handshake_msg() throws IOException {

        ByteArrayInputStream inputStream = new ByteArrayInputStream(new byte[0]);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);

        recordTransport.writeHandshakeMsg(HandshakeMsg.getInstance(handshakeData));

        assertThat(outputStream.toByteArray(), is(handshakeRecord));
    }

    @Test
    public void should_write_handshake_msg_after_update_cipher() throws IOException {

        ByteArrayInputStream inputStream = new ByteArrayInputStream(new byte[0]);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);
        tlsEventBus.postEvent(new GenerateSecurityParametersFinishedEvent(securityParameters));
        tlsEventBus.postEvent(new ChangeWriteCipherEvent());

        recordTransport.writeHandshakeMsg(HandshakeMsg.getInstance(sentFinishData));
        assertThat(outputStream.toByteArray(), is(sentFinishRecord));

    }

    @Test
    public void should_write_application_msg_after_update_cipher() throws IOException {

        ByteArrayInputStream inputStream = new ByteArrayInputStream(new byte[0]);
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);
        tlsEventBus.postEvent(new GenerateSecurityParametersFinishedEvent(securityParameters));
        tlsEventBus.postEvent(new ChangeWriteCipherEvent());

        recordTransport.writeHandshakeMsg(HandshakeMsg.getInstance(sentFinishData));
        assertThat(outputStream.toByteArray(), is(sentFinishRecord));
        outputStream.reset();

        recordTransport.writeApplicationMsg(sentApplicationData);
        assertThat(outputStream.toByteArray(), is(sentApplicationRecord));

    }

    @Test
    public void should_read_application_msg_after_update_cipher() throws IOException {

        ByteArrayInputStream inputStream =
                new ByteArrayInputStream(Bytes.concat(revFinishRecord, revApplicationRecord));
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        RecordTransport recordTransport = new RecordTransport(tlsEventBus, tlsCrypto, inputStream, outputStream);
        tlsEventBus.postEvent(new GenerateSecurityParametersFinishedEvent(securityParameters));
        tlsEventBus.postEvent(new ChangeReadCipherEvent());

        recordTransport.readHandshakeMsg();
        TLSText tlsText = recordTransport.readApplicationMsg();

        assertThat(tlsText.contentType, is(ContentType.APPLICATION_DATA));
        assertThat(tlsText.fragment, is(revApplicationData));
    }


}
